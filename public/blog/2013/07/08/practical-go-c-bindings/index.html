<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Practical Go: C Bindings &middot; Jeremy Saenz</title>

  
  <link rel="stylesheet" href="http://codegangsta.io/css/poole.css">
  <link rel="stylesheet" href="http://codegangsta.io/css/hyde.css">
  <link rel="stylesheet" href="http://codegangsta.io/css/hyde-x.css">
  <link rel="stylesheet" href="http://codegangsta.io/css/codegangsta.css">
  <link rel="stylesheet" href="http://codegangsta.io/css/highlight/github.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic,900italic">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  <link href="" rel="alternate" type="application/rss+xml" title="codegangsta.io &middot; Jeremy Saenz" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body class="theme-base-0d">

<div class="topbar topbar-small">
  <div class="color-overlay"></div>
  <div class="container">
    <div class="title">
      <h1>CODE GANGSTA</h1>
    </div>

    <div class="menu">
      <a href="http://codegangsta.io/">Blog</a> ·
      <a href="http://codegangsta.io/">Tools</a> ·
      <a href="http://codegangsta.io/">Screencasts</a> ·
      <a href="http://codegangsta.io/">Books</a> ·
      <a href="http://codegangsta.io/">Talks</a> ·
      <a href="http://codegangsta.io/">About</a>
    </div>

  </div>
</div>

<div class="content container">
  <div class="post">
    <h1>Practical Go: C Bindings</h1>
    <span class="post-date">Jul 8, 2013 &middot; 3 minute read &middot; <a href="http://codegangsta.io/blog/2013/07/08/practical-go-c-bindings/#disqus_thread">Comments</a>
    
    <br/>
    
    
    </span>
    

<p>I have been playing with <a href="http://golang.org/">Go</a> lately. The language itself has a lot going for it, one of which is a decent set of interop with existing C code. Today I am going to walk you through a practical example of how this is done by showing some code that I have been working on lately with Go.</p>

<h2 id="the-simplest-hello-world:039e70d11edfc9565aa0772639c60162">The Simplest Hello World</h2>

<p>Assuming you have your <a href="http://golang.org/doc/code.html">Go development environment all set up,</a> go ahead and create a new go file with the following contents:</p>

<pre><code class="language-go">package main

func main() {
  println(&quot;Hello world&quot;)
}
</code></pre>

<p>Running this should obviously print &ldquo;Hello world&rdquo;. Let&rsquo;s move on!</p>

<h2 id="using-libspotify:039e70d11edfc9565aa0772639c60162">Using libspotify</h2>

<p>Lets start creating some C bindings for libspotify! libspotify is a C api distributed by Spotify that basically allows us to do everything a typical spotify app can do; log in, play, music, manipulate playlists - all available to us with libspotify.</p>

<p>For the sake of keeping this post short and to the point, we will just be creating a <code>sp_session</code> object. This session will lay some groundwork for us to log in and do the fun stuff libspotify allows us to do. Why don&rsquo;t we dive in:</p>

<pre><code class="language-go">package main

type Session struct {
  session *C.sp_session
}

func main() {
  println(&quot;Hello world&quot;)
}
</code></pre>

<p>Running this will result in an error</p>

<pre><code class="language-text">./bindings.go:4: undefined: C
</code></pre>

<p>This is because we actually need to use some special magic that Go provides for us, the C package.</p>

<pre><code class="language-go">package main

import &quot;C&quot;

type Session struct {
  session *C.sp_session
}

func main() {
  println(&quot;Hello world&quot;)
}
</code></pre>

<p>This gives us a different error:</p>

<pre><code class="language-text">error: 'sp_session' undeclared (first use in this function)
error: (Each undeclared identifier is reported only once
</code></pre>

<p>Cool, so it sees the C package, but sp_session doesn&rsquo;t exist. This is because we need to include libspotify using the <code>#include</code> directive for the C preprocessor. First make sure you have libspotify installed. On a Mac you can run <code>brew install libspotify</code>. Now try to run the following code:</p>

<pre><code class="language-go">package main

/*
#include &lt;libspotify/api.h&gt;
*/
import &quot;C&quot;

type Session struct {
  session *C.sp_session
}

func main() {
  println(&quot;Hello world&quot;)
}
</code></pre>

<p>This should compile and run since <code>sp_session</code> now resides in the global C namespace! This works great for things that exist in the header, but it breaks down when we try to initialize our session:</p>

<pre><code class="language-go">package main

/*
#include &lt;libspotify/api.h&gt;
*/
import &quot;C&quot;
import &quot;unsafe&quot;

type Session struct {
  session *C.sp_session
}

func main() {
  key := &quot;appkey_good&quot;
  session := Session{}
  appkey := C.CString(key)
  appkey_size := len(key)

  var config = C.sp_session_config {
    api_version:          C.SPOTIFY_API_VERSION,
    cache_location:       C.CString(&quot;.spotify/&quot;),
    settings_location:    C.CString(&quot;.spotify/&quot;),
    user_agent:           C.CString(&quot;spotify for go&quot;),
    application_key:      unsafe.Pointer(appkey),
    application_key_size: C.size_t(appkey_size)
  }

  C.sp_session_create(&amp;config, &amp;session.session)
}
</code></pre>

<p>Will result in the following error:</p>

<pre><code class="language-text">Undefined symbols for architecture x86_64:
  &quot;_sp_session_create&quot;, referenced from:
      __cgo_90280c6a3021_Cfunc_sp_session_create in bindings.cgo2.o
     (maybe you meant: __cgo_90280c6a3021_Cfunc_sp_session_create)
ld: symbol(s) not found for architecture x86_64
collect2: ld returned 1 exit status
</code></pre>

<p>This is because we didn&rsquo;t link libspotify. This is an easy fix, add this in the comment above <code>import &quot;C&quot;</code>:</p>

<pre><code class="language-text">#cgo LDFLAGS: -lspotify.12
</code></pre>

<p>Your code should compile and link fine. You will get a SIGSEGV in your application, this is becuase we specified a bogus app key. We will cover this in detail during Part 2 of <em>C Bindings in Go: A Practical Example</em>.</p>

<p>Until next time!</p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "codegangsta";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "codegangsta";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="http://codegangsta.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>
