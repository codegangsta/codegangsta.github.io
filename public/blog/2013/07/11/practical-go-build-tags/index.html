<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Practical Go: Build Tags &middot; Jeremy Saenz</title>

  
  <link rel="stylesheet" href="http://localhost:1313/css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313/css/hyde.css">
  <link rel="stylesheet" href="http://localhost:1313/css/hyde-x.css">
  <link rel="stylesheet" href="http://localhost:1313/css/codegangsta.css">
  <link rel="stylesheet" href="http://localhost:1313/css/highlight/github.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic,900italic">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  <link href="" rel="alternate" type="application/rss+xml" title="codegangsta.io &middot; Jeremy Saenz" />

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body class="theme-base-0d">

<div class="topbar topbar-small">
  <div class="color-overlay"></div>
  <div class="container">
    <div class="title">
      <h1>CODE GANGSTA</h1>
    </div>

    <div class="menu">
      <a href="http://localhost:1313/">Blog</a> ·
      <a href="http://localhost:1313/">Tools</a> ·
      <a href="http://localhost:1313/">Screencasts</a> ·
      <a href="http://localhost:1313/">Books</a> ·
      <a href="http://localhost:1313/">Talks</a> ·
      <a href="http://localhost:1313/">About</a>
    </div>

  </div>
</div>

<div class="content container">
  <div class="post">
    <h1>Practical Go: Build Tags</h1>
    <span class="post-date">Jul 11, 2013 &middot; 2 minute read &middot; <a href="http://localhost:1313/blog/2013/07/11/practical-go-build-tags/#disqus_thread">Comments</a>
    
    <br/>
    
    
    </span>
    

<p>In our <a href="/blog/2013/07/08/practical-go-c-bindings/">last post</a> we wrote a simple set of bindings for libspotify in Go. By the end of the post we had an example compiling, but we had a bad API key for our spotify application. One obvious way to recify this would be to grab an API key if you are a Spotfy Premium user. Another workaround is to use a <em>mock</em> library to make sure the code is working the way we want. We will link this mock library with <strong>Build tags.</strong></p>

<h2 id="mocking-spotify:213ae47dc89dbd60677f5d7fdbfb82a7">Mocking Spotify</h2>

<p>Start by installing libmockspotify:</p>

<pre><code class="language-text">git clone git@github.com:mopidy/libmockspotify.git
cd libmockspotify
./autogen.sh
./configure
make
sudo make install
</code></pre>

<p>Once libmockspotify is installed, we can link to that instead of the real libspotify:</p>

<pre><code class="language-go">package main

/*
#include &lt;libspotify/api.h&gt;
#cgo LDFLAGS: -lmockspotify.2
*/
import &quot;C&quot;
import &quot;unsafe&quot;

type Session struct {
  session *C.sp_session
}

func main() {
key := &quot;appkey_good&quot;
session := Session{}
  appkey := C.CString(key)
  appkey_size := len(key)

  var config = C.sp_session_config {
    api_version:          C.SPOTIFY_API_VERSION,
    cache_location:       C.CString(&quot;.spotify/&quot;),
    settings_location:    C.CString(&quot;.spotify/&quot;),
    user_agent:           C.CString(&quot;spotify for go&quot;),
    application_key:      unsafe.Pointer(appkey),
    application_key_size: C.size_t(appkey_size)
  }

  C.sp_session_create(&amp;config, &amp;session.session)
  println(&quot;Session created!&quot;)
}
</code></pre>

<p>The following code should output:</p>

<pre><code class="language-text">Session created!
</code></pre>

<h2 id="using-build-tags:213ae47dc89dbd60677f5d7fdbfb82a7">Using build tags</h2>

<p>It&rsquo;s great that we have libmockspotify for testing purposes, but it doesn&rsquo;t make sense to always mock spotify in our project. This is where <strong>Build Tags</strong> come into play. We can use build tags to conditionally choose which library to link to.</p>

<p>Let&rsquo;s link both libspotify and libmockspotify in our file:</p>

<pre><code class="language-go">/*
#include &lt;libspotify/api.h&gt;
#cgo LDFLAGS: -lmockspotify.2
#cgo LDFLAGS: -lspotify.12
*/
</code></pre>

<p>This approach obviously will not work as is, so we will instead link each library conditionally based on the <em>mock</em> build take that we will define:</p>

<pre><code class="language-go">/*
#include &lt;libspotify/api.h&gt;
#cgo mock LDFLAGS: -lmockspotify.2
#cgo !mock LDFLAGS: -lspotify.12
*/
</code></pre>

<p>This will link libmockspotify when the <em>mock</em> build tag is defined, otherwise we will use the real libspotify. So then how do we define build tags? Simple:</p>

<pre><code class="language-text">go run -tags mock myfile.go
</code></pre>

<p>Thats enough for today, have fun with build tags! I will leave you with one more pro tip!</p>

<p>In my <code>~/.vim</code> folder I have a ftplugin for Go that includes a binding for running tests:</p>

<pre><code class="language-text">nmap &lt;Leader&gt;t :!go test -tags test &lt;cr&gt;
</code></pre>

<p>You see how I include the <em>test</em> tag in all of my test running? This makes it convenient when linking mock libraries specific for running tests!</p>

<p>Until next time!</p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "codegangsta";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "codegangsta";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="http://localhost:1313/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
